<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer-fontawesome/polymer-fontawesome.html">
<link rel="import" href="../bower_components/sortable-table/sortable-table.html">
<link rel="import" href="../bower_components/core-list/core-list.html">

<script src="../bower_components/js-xlsx/dist/jszip.js"></script>
<script src="../bower_components/js-xlsx/dist/xlsx.min.js"></script>

<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-header.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-project-browser.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-job-list.html">

<link rel="import" href="../lib/jsorolla/src/network-viewer/jso-network-viewer.html">

<polymer-element name="cell-maps-element">
    <template>
        <style>
            :host {
                display: block;
                position: relative;

                cursor: default;
                font-size: 13px;
            }
            jso-project-browser {
                height: calc(100vh - 60px);
            }

            jso-network-viewer {
                height: calc(100vh - 90px);
            }

            jso-job-list {
                height: calc(100vh - 60px);
                width: 250px;
                top: 60px;
                right: 0px;
            }



        </style>
        <jso-header selectedOption="{{selectedOption}}" userData="{{userData}}"  showJobs="{{showJobs}}">
            <span class="title">Cell Maps</span>
            <span class="description">Systems Biology Visualization</span>
        </jso-header>
        <template if="{{selectedOption == 'projects' }}">
            <jso-project-browser
                    userData="{{userData}}"
                    studies="{{studies}}"
                    selectedStudy="{{selectedStudy}}"
                    selectedProject="{{selectedProject}}">
            </jso-project-browser>
        </template>

        <jso-network-viewer
                id="networkViewer"
                hidden?="{{selectedOption != 'home'}}"
                >
        </jso-network-viewer>


        <template if="{{ showJobs }}">
            <jso-job-list
                    on-job-item-click="{{handleJobItemClick}}"
                    userData="{{userData}}"
                    selectedOption="{{selectedOption}}"
                    selectedStudy="{{selectedStudy}}"
                    showJobs="{{showJobs}}"></jso-job-list>
        </template>

    </template>
    <script>
        Polymer({
            created: function () {
                this.selectedOption = 'home';

                this.showJobs = false;
                this.userData;


                this.selectedProject;
                this.selectedStudy;
                this.studies;

                this.saveInProgress = false;
            },
            ready: function () {
                var me = this;
                this.networkViewer = this.$.networkViewer;
                this._loadNetworkSessionLocalStorage();

                setInterval(function () {
                    if (me.saveInProgress == false) {
                        me.saveInProgress = true;
                        me.networkViewer.saveLocalStorage();
                        me.saveInProgress = false;
                    } else {
                        console.log("saveInProgress is true");
                    }
                }, 15000);
            },
            userDataChanged: function (oldValue, newValue) {
                var me = this;
                this.selectedProject = this.userData.projects[0];

                OpencgaManager.projects.studies({
                    id: this.selectedProject.id,
                    query: {
                        sid: Cookies("bioinfo_sid")
                    },
                    request: {
                        //method: 'POST',
                        success: function (response) {
                            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                                me.studies = response.response[0].result;
                                me.selectedStudy = me.studies[0];
                            } else {
                                console.log(response.error);
                                console.log(response.response[0].errorMsg);
                            }
                        },
                        error: function () {
                            console.log('Server error, try again later.');
                        }
                    }
                })
            },
            _loadNetworkSessionLocalStorage: function () {
                if (this.networkViewer.loadLocalStorage()) {
                    console.log('Session found :), restoring information... ')

                } else {
                    console.log('Session not found :( ')
                }
            },
            __iliketomoveit: function () {
                this.$.networkViewer.setLayout('Force directed (simulation)')
            },
        });
    </script>
</polymer-element>
